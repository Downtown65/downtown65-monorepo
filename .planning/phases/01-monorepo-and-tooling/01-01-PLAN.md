---
phase: 01-monorepo-and-tooling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pnpm-workspace.yaml
  - package.json
  - .npmrc
  - .gitignore
  - tsconfig.base.json
  - tsconfig.json
  - biome.json
  - knip.json
  - lefthook.yml
  - CLAUDE.md
  - apps/api/package.json
  - apps/api/tsconfig.json
  - apps/api/wrangler.jsonc
  - apps/api/src/index.ts
  - apps/events/package.json
  - apps/events/tsconfig.json
  - apps/events/wrangler.jsonc
  - apps/events/src/index.ts
  - apps/www/package.json
  - apps/www/tsconfig.json
  - apps/www/wrangler.jsonc
  - apps/www/src/index.ts
  - packages/shared/package.json
  - packages/shared/tsconfig.json
  - packages/shared/src/index.ts
autonomous: true
requirements:
  - INFR-01
  - INFR-02
  - INFR-03
  - INFR-06

must_haves:
  truths:
    - "All workspace dependencies resolve and install from the repo root without errors"
    - "All source files across all packages pass Biome lint and format checks"
    - "No unused code, exports, or dependencies exist across any workspace"
    - "All workspaces use consistent dependency versions with no version mismatches"
    - "All workspaces typecheck without errors via TypeScript project references"
    - "Git push triggers Lefthook pre-push hooks that run lint, typecheck, and knip"
    - "CLAUDE.md exists at repo root with project conventions"
  artifacts:
    - path: "pnpm-workspace.yaml"
      provides: "Workspace definitions and pnpm catalog with pinned versions"
      contains: "catalog:"
    - path: "package.json"
      provides: "Root package.json with workspace scripts and shared devDependencies"
      contains: "pnpm -r run build"
    - path: "tsconfig.base.json"
      provides: "Shared TypeScript compiler options"
      contains: "strict"
    - path: "tsconfig.json"
      provides: "Root project references for incremental builds"
      contains: "references"
    - path: "biome.json"
      provides: "Root Biome config with strict linting and formatting"
      contains: "recommended"
    - path: "knip.json"
      provides: "Knip config for dead code detection across workspaces"
      contains: "workspaces"
    - path: "lefthook.yml"
      provides: "Pre-push hooks for lint, typecheck, knip"
      contains: "pre-push"
    - path: "CLAUDE.md"
      provides: "Claude development guide with project conventions"
    - path: "apps/api/package.json"
      provides: "API app package definition"
      contains: "@dt65/api"
    - path: "apps/events/package.json"
      provides: "Events app package definition"
      contains: "@dt65/events"
    - path: "apps/www/package.json"
      provides: "WWW app package definition"
      contains: "@dt65/www"
    - path: "packages/shared/package.json"
      provides: "Shared package definition with barrel export"
      contains: "@dt65/shared"
  key_links:
    - from: "apps/*/tsconfig.json"
      to: "tsconfig.base.json"
      via: "extends"
      pattern: "extends.*tsconfig\\.base\\.json"
    - from: "apps/*/package.json"
      to: "pnpm-workspace.yaml"
      via: "catalog: protocol"
      pattern: "catalog:"
    - from: "lefthook.yml"
      to: "biome.json"
      via: "pnpm biome check"
      pattern: "biome check"
---

<objective>
Create a fully configured TypeScript monorepo with pnpm workspaces, 3 app scaffolds (api, events, www), a shared package, strict code quality tooling (Biome, Knip, Sherif), Lefthook pre-push hooks, and CLAUDE.md development guide.

Purpose: Establish the development foundation that all subsequent phases build upon. Every future code change will use this workspace structure, these quality checks, and these conventions.

Output: A working monorepo where `pnpm install`, `pnpm check`, `pnpm tsc --build`, and `git push` (with Lefthook hooks) all succeed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-monorepo-and-tooling/01-CONTEXT.md
@.planning/phases/01-monorepo-and-tooling/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1a: Create root monorepo configuration and TypeScript base</name>
  <files>
    pnpm-workspace.yaml
    package.json
    .npmrc
    .gitignore
    tsconfig.base.json
    tsconfig.json
  </files>
  <action>
    Create the root-level monorepo configuration files from scratch. This is a green-field project — no existing code.

    1. `pnpm-workspace.yaml` — Define workspace packages (`apps/*`, `packages/*`). Add `onlyBuiltDependencies: [lefthook]` so Lefthook's postinstall hook runs. Add `catalog:` section with ALL pinned versions from CONTEXT.md specifics:
       - `@biomejs/biome`: 2.3.14
       - `@cloudflare/vitest-pool-workers`: 0.12.1
       - `@hono/zod-openapi`: 1.2.1
       - `@types/node`: 25.0.3
       - `@vitest/coverage-v8`: 3.2.0
       - `jwt-decode`: 4.0.0
       - `knip`: 5.83.0
       - `rimraf`: 6.1.2
       - `tsx`: 4.21.0
       - `typescript`: 5.9.3
       - `vitest`: 3.2.0
       - `wrangler`: 4.63.0
       - `zod`: 4.3.5

    2. `package.json` — Root package with:
       - `"name": "@dt65/root"`, `"private": true`
       - `"type": "module"`
       - `"packageManager": "pnpm@10.4.1"` (or latest 10.x at implementation time)
       - Scripts: `build` (`pnpm -r run build`), `check` (`biome check . && pnpm knip && pnpm dlx sherif@latest`), `lint` (`biome check --write .`), `typecheck` (`tsc --build`), `test` (`pnpm -r run test`), `clean` (`pnpm -r run clean`)
       - devDependencies using `catalog:`: `@biomejs/biome`, `knip`, `typescript`, `@types/node`, `tsx`, `rimraf`
       - `lefthook` as devDependency at `"latest"` (not catalog — it manages itself)

    3. `.npmrc` — Add `auto-install-peers=true` and `strict-peer-dependencies=false`

    4. `.gitignore` — Include: `node_modules/`, `dist/`, `.wrangler/`, `.dev.vars`, `*.tsbuildinfo`, `.DS_Store`, `coverage/`

    5. `tsconfig.base.json` — Shared compiler options per RESEARCH.md Pattern 2:
       - `target: "ES2022"`, `module: "ESNext"`, `moduleResolution: "bundler"`
       - `lib: ["ES2022"]`
       - `strict: true`, `noUncheckedIndexedAccess: true`, `exactOptionalPropertyTypes: true`
       - `skipLibCheck: true`, `isolatedModules: true`, `verbatimModuleSyntax: true`
       - `resolveJsonModule: true`, `declaration: true`, `declarationMap: true`, `sourceMap: true`
       - `composite: true`, `incremental: true`
       - `forceConsistentCasingInFileNames: true`, `esModuleInterop: true`

    6. `tsconfig.json` (root) — Project references only:
       - `"files": []`
       - `"references"` pointing to all 4 workspaces: `apps/api`, `apps/events`, `apps/www`, `packages/shared`

    **Important constraints:**
    - Use `catalog:` protocol for ALL dependency versions listed in the pnpm catalog (not hardcoded versions)
    - Do NOT add `@hono/zod-openapi`, `zod`, `jwt-decode` to any package.json yet — they are in the catalog for later phases
  </action>
  <verify>
    Verify all 6 root files exist and have correct content.
    Run `pnpm install` from repo root — must complete without errors (workspace dirs don't exist yet but root deps should install).
  </verify>
  <done>
    Root monorepo configuration is in place: pnpm workspace with catalog, root package.json with scripts and shared devDeps, tsconfig base with strict settings, root project references, .npmrc, and .gitignore.
  </done>
</task>

<task type="auto">
  <name>Task 1b: Create workspace scaffolds (apps and shared package)</name>
  <files>
    apps/api/package.json
    apps/api/tsconfig.json
    apps/api/wrangler.jsonc
    apps/api/src/index.ts
    apps/events/package.json
    apps/events/tsconfig.json
    apps/events/wrangler.jsonc
    apps/events/src/index.ts
    apps/www/package.json
    apps/www/tsconfig.json
    apps/www/wrangler.jsonc
    apps/www/src/index.ts
    packages/shared/package.json
    packages/shared/tsconfig.json
    packages/shared/src/index.ts
  </files>
  <action>
    Create all 4 workspace packages using the root config from Task 1a.

    **App scaffolds (apps/api, apps/events, apps/www):**

    For each app create:

    1. `package.json`:
       - Names: `@dt65/api`, `@dt65/events`, `@dt65/www`
       - `"private": true`, `"type": "module"`
       - Scripts: `dev` (`wrangler dev`), `build` (`wrangler deploy --dry-run`), `typecheck` (`tsc --noEmit`), `test` (`vitest run`), `clean` (`rimraf dist`)
       - For api: devDeps `wrangler`, `vitest`, `@cloudflare/vitest-pool-workers`, `@vitest/coverage-v8`, `rimraf`, `typescript` (all `catalog:`). Dependencies: `@dt65/shared` as `workspace:*`
       - For events: devDeps `wrangler`, `vitest`, `@vitest/coverage-v8`, `rimraf`, `typescript` (all `catalog:`). Dependencies: `@dt65/shared` as `workspace:*`
       - For www: devDeps `wrangler`, `vitest`, `@vitest/coverage-v8`, `rimraf`, `typescript` (all `catalog:`). Dependencies: `@dt65/shared` as `workspace:*`

    2. `tsconfig.json`:
       - `"extends": "../../tsconfig.base.json"`
       - `"compilerOptions"`: `outDir: "dist"`, `rootDir: "src"`, `paths: { "@/*": ["./src/*"] }`
       - `"include": ["src"]`
       - `"references": [{ "path": "../../packages/shared" }]`

    3. `wrangler.jsonc`:
       - api: `name: "dt65-api"`, `main: "src/index.ts"`, `compatibility_date: "2026-02-01"`, `compatibility_flags: ["nodejs_compat_v2"]`, `observability: { enabled: true }`
       - events: `name: "dt65-events"`, same structure (no D1 binding — it's a frontend app)
       - www: `name: "dt65-www"`, same structure

    4. `src/index.ts` — Minimal placeholder for each app:
        - api: `export default { async fetch(): Promise<Response> { return new Response("dt65-api"); } };`
        - events: `export default { async fetch(): Promise<Response> { return new Response("dt65-events"); } };`
        - www: `export default { async fetch(): Promise<Response> { return new Response("dt65-www"); } };`

    **Shared package (packages/shared):**

    5. `package.json`:
        - `"name": "@dt65/shared"`, `"private": true`, `"type": "module"`
        - `"main": "src/index.ts"`, `"types": "src/index.ts"`
        - `"exports": { ".": { "import": "./src/index.ts", "types": "./src/index.ts" } }`
        - Scripts: `typecheck`, `test`, `clean`
        - devDependencies: `typescript`, `vitest`, `rimraf` (all `catalog:`)

    6. `tsconfig.json`:
        - `"extends": "../../tsconfig.base.json"`
        - `"compilerOptions"`: `outDir: "dist"`, `rootDir: "src"`
        - `"include": ["src"]`
        - NO `paths` alias in shared package (per anti-pattern: `@/` only in apps)
        - NO references (shared is a leaf)

    7. `src/index.ts` — Barrel export placeholder:
        ```typescript
        // @dt65/shared - public API
        // Export shared types, utilities, and constants here
        export const DT65_APP_NAME = "Downtown 65";
        ```

    **Important constraints:**
    - Use `catalog:` protocol for ALL dependency versions (not hardcoded versions)
    - Each app's `tsconfig.json` must reference `../../packages/shared` in its `references` array
  </action>
  <verify>
    Run `pnpm install` from repo root — must complete without errors.
    Run `pnpm tsc --build` — must complete without errors.
    Run `pnpm -r run build` — must complete without errors (dry-run deploy for each app).
    Verify `node_modules/` is created and all 4 workspaces are linked.
  </verify>
  <done>
    All workspace package.json files use `catalog:` protocol for versions. `pnpm install` succeeds. `pnpm tsc --build` succeeds with no type errors. `pnpm -r run build` succeeds (wrangler dry-run for each app). Project references work — editing a type in `@dt65/shared` is visible from apps.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure code quality tools, Lefthook hooks, and CLAUDE.md</name>
  <files>
    biome.json
    knip.json
    lefthook.yml
    CLAUDE.md
  </files>
  <action>
    Set up Biome, Knip, Lefthook, and CLAUDE.md. These files are all at the repo root.

    **1. `biome.json` — Root Biome v2 config:**

    Per RESEARCH.md Pattern 3 and user decisions (strict mode, 2-space indent, semicolons, ban console.log):

    ```json
    {
      "$schema": "https://biomejs.dev/schemas/2.3.14/schema.json",
      "formatter": {
        "enabled": true,
        "indentStyle": "space",
        "indentWidth": 2,
        "lineWidth": 100
      },
      "linter": {
        "enabled": true,
        "rules": {
          "recommended": true,
          "correctness": "error",
          "suspicious": {
            "recommended": true,
            "noConsole": "error"
          },
          "style": "warn",
          "complexity": "warn",
          "performance": "error"
        }
      },
      "javascript": {
        "formatter": {
          "semicolons": "always",
          "quoteStyle": "single"
        }
      },
      "assist": {
        "actions": {
          "source": {
            "organizeImports": "on"
          }
        }
      },
      "vcs": {
        "enabled": true,
        "clientKind": "git",
        "useIgnoreFile": true
      }
    }
    ```

    Note: The `noConsole` rule bans `console.log` in source files. If test files need console output later, create nested `biome.json` in test directories with `"extends": "//"` and override `noConsole` to `"off"` (Claude's discretion per user decision).

    **2. `knip.json` — Dead code detection config:**

    Per RESEARCH.md and Knip skill rules. Follow the configuration-first workflow from the knip skill:

    ```json
    {
      "$schema": "https://unpkg.com/knip@5/schema.json",
      "workspaces": {
        ".": {
          "ignoreDependencies": ["lefthook"]
        },
        "apps/api": {
          "entry": "src/index.ts"
        },
        "apps/events": {
          "entry": "src/index.ts"
        },
        "apps/www": {
          "entry": "src/index.ts"
        },
        "packages/shared": {
          "includeEntryExports": true
        }
      }
    }
    ```

    After creating the config, run `pnpm knip` and address any configuration hints or false positives per the Knip skill workflow (Step 2-4: run, read hints, adjust config, repeat). The `ignoreDependencies: ["lefthook"]` handles the known false positive since Lefthook uses postinstall hooks rather than code imports. The `includeEntryExports: true` for shared prevents barrel export false positives.

    **3. `lefthook.yml` — Pre-push hooks:**

    Per RESEARCH.md Pattern 5 and user decision (pre-push, check only, no auto-fix):

    ```yaml
    pre-push:
      parallel: true
      jobs:
        - name: lint
          run: pnpm biome check .

        - name: typecheck
          run: pnpm tsc --build

        - name: knip
          run: pnpm knip
    ```

    Note: `tsc --build` uses project references for incremental typechecking and writes `.tsbuildinfo` files (which are gitignored). The `--noEmit` flag is incompatible with `--build` mode, so we use `--build` directly. The hooks run in parallel for speed.

    **4. `CLAUDE.md` — Claude development guide:**

    Draft CLAUDE.md with project conventions (user will review before finalizing). Include:

    - **Project overview:** DT65 sports club ecosystem — 3 apps (api, events, www) + shared package
    - **Tech stack summary:** pnpm workspaces, TypeScript strict, Biome, Knip, Sherif, Cloudflare Workers
    - **Workspace commands:**
      - `pnpm install` — install all deps
      - `pnpm build` — build all apps
      - `pnpm check` — lint + knip + sherif
      - `pnpm lint` — lint with auto-fix
      - `pnpm typecheck` — typecheck all workspaces
      - `pnpm test` — run all tests
    - **Coding conventions:**
      - Conventional Commits: `feat:`, `fix:`, `chore:`, `docs:` with optional scope
      - Branch naming: `type/description` (e.g. `feat/event-crud`)
      - File naming: PascalCase for React components, kebab-case for everything else
      - Tests in `__tests__/` directories
      - Path aliases: `@/` for internal imports within each app
      - Result types for error handling: `{ ok: true, data } | { ok: false, error }`
      - Interface pattern for external dependencies
      - Zod validation for all `c.env` bindings
      - No `console.log` — use logger (LogLayer, configured in later phases)
    - **TypeScript rules:** strict mode, `noUncheckedIndexedAccess`, `exactOptionalPropertyTypes`
    - **Dependencies:** Use `catalog:` protocol, add new shared versions to `pnpm-workspace.yaml` catalog
    - **Pre-push hooks:** Lefthook runs lint + typecheck + knip on push — fix all errors before pushing

    Keep CLAUDE.md concise and actionable. Target 100-150 lines. This is a working reference, not documentation.
  </action>
  <verify>
    Run `pnpm biome check .` — must pass with no errors on all source files.
    Run `pnpm knip` — must pass with no issues (iterate on config if needed).
    Run `pnpm dlx sherif@latest` — must pass with no dependency inconsistencies.
    Run `pnpm check` — combined check must pass.
    Verify `lefthook.yml` is valid by running `npx lefthook run pre-push` (may need git init context).
    Verify `CLAUDE.md` exists and contains key sections.
  </verify>
  <done>
    `pnpm check` passes (Biome + Knip + Sherif all clean). Lefthook is configured and `git push` triggers pre-push hooks. CLAUDE.md exists with project conventions. No Biome warnings or errors in any workspace. Knip reports zero unused files, exports, or dependencies.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full Phase 1 Plan 01 deliverable:

1. `pnpm install` — succeeds, all 4 workspaces linked
2. `pnpm tsc --build` — no type errors across all workspaces
3. `pnpm -r run build` — all 3 apps build successfully (wrangler dry-run)
4. `pnpm check` — Biome lint, Knip dead code, Sherif consistency all pass
5. `pnpm test` — test runner works (even if no tests yet)
6. `ls .git/hooks/` — Lefthook hooks are installed
7. `CLAUDE.md` exists and is readable

All files use the conventions from CONTEXT.md (Conventional Commits, file naming, etc.).
</verification>

<success_criteria>
- pnpm workspace with catalog protocol is functional — `pnpm install` succeeds
- All 4 workspaces (api, events, www, shared) build and typecheck without errors
- Biome strict linting passes on all source files
- Knip reports zero issues
- Sherif reports zero inconsistencies
- Lefthook pre-push hooks are installed and runnable
- CLAUDE.md exists with project conventions
- TypeScript project references enable incremental builds across workspaces
</success_criteria>

<output>
After completion, create `.planning/phases/01-monorepo-and-tooling/01-01-SUMMARY.md`
</output>
