name: PR Cleanup

on:
  pull_request:
    branches: [main]
    types: [closed]

jobs:
  cleanup:
    name: Clean Up Preview Resources
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      PR_NUM: ${{ github.event.pull_request.number }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup

      - name: Delete preview Workers
        run: |
          npx wrangler delete --name "dt65-api-pr-${PR_NUM}" --force 2>/dev/null || true
          npx wrangler delete --name "dt65-events-pr-${PR_NUM}" --force 2>/dev/null || true
          npx wrangler delete --name "dt65-www-pr-${PR_NUM}" --force 2>/dev/null || true
          echo "Deleted preview Workers for PR #${PR_NUM}"

      - name: Delete per-PR D1 database
        run: |
          DB_NAME="dt65-pr-${PR_NUM}"
          # Use d1 info to check if DB exists, then delete by name
          DB_ID=$(npx wrangler d1 info "$DB_NAME" --json 2>/dev/null | jq -r '.uuid' 2>/dev/null)
          if [ -n "$DB_ID" ] && [ "$DB_ID" != "null" ]; then
            npx wrangler d1 delete "$DB_NAME" -y 2>/dev/null || true
            echo "Deleted D1 database: $DB_NAME ($DB_ID)"
          else
            echo "D1 database $DB_NAME not found, skipping"
          fi
